# Nintendo Switch 爬虫数据优化实施任务

## 任务概述

将设计文档转换为具体的实施任务，确保以最小的破坏性影响优化爬虫数据提取逻辑。

## 实施任务

### 1. 爬虫逻辑优化

- [ ] 1.1 实现智能容量获取算法
  - 创建 `getRomSize` 函数，优先选择BEE平台，回退到HAC平台
  - 添加数据验证和错误处理
  - 编写单元测试验证算法正确性
  - _需求: 1.1, 1.2, 1.3, 1.4_

- [ ] 1.2 实现截图数据清理算法
  - 创建 `getCleanScreenshots` 函数，过滤无效URL
  - 确保返回有效的字符串数组
  - 添加URL格式验证
  - _需求: 3.1, 3.2, 3.3_

- [ ] 1.3 添加平台名称提取逻辑
  - 修改数据提取逻辑，同时获取技术代号和友好名称
  - 实现回退机制，当友好名称不可用时使用技术代号
  - _需求: 2.1, 2.2, 2.3_

- [ ] 1.4 更新爬虫数据提取主逻辑
  - 在 `game-scraper.ts` 中集成新的提取算法
  - 更新 `ScrapedGameInfo` 接口定义
  - 添加错误处理和日志记录
  - _需求: 1.1, 2.1, 3.1_

- [ ] 1.5 创建爬虫单元测试
  - 使用NS1和NS2测试数据验证提取逻辑
  - 测试边界情况和错误处理
  - 验证数据格式和类型正确性
  - _需求: 1.1, 2.1, 3.1_

### 2. 数据库结构更新

- [ ] 2.1 设计数据库迁移脚本
  - 创建SQL脚本添加 `platform_name` 字段
  - 设计向后兼容的迁移策略
  - 创建回滚脚本以防需要撤销更改
  - _需求: 4.1, 4.2, 4.3_

- [ ] 2.2 更新数据库类型定义
  - 在 `types/index.ts` 中添加新字段定义
  - 更新 `GameInsert` 接口
  - 确保类型安全和一致性
  - _需求: 4.1, 5.1_

- [ ] 2.3 测试数据库迁移
  - 在测试环境中执行迁移脚本
  - 验证现有数据完整性
  - 测试新字段的读写操作
  - _需求: 4.1, 4.2, 4.3_

### 3. API服务适配

- [ ] 3.1 更新API响应结构
  - 修改 `getSystemStats` 和 `getGames` 方法
  - 确保新字段包含在API响应中
  - 保持向后兼容性，不移除现有字段
  - _需求: 5.1, 5.2, 5.3_

- [ ] 3.2 更新API类型定义
  - 在API项目中更新 `Game` 接口
  - 添加 `platform_name` 字段定义
  - 确保TypeScript类型检查通过
  - _需求: 5.1, 5.2_

- [ ] 3.3 测试API兼容性
  - 验证现有API调用仍然正常工作
  - 测试新字段的返回和处理
  - 确保错误处理机制正常
  - _需求: 5.1, 5.2, 5.3_

### 4. 管理后台适配

- [ ] 4.1 更新游戏列表显示
  - 修改 `GamesList.tsx` 以显示友好的平台名称
  - 保持现有的容量显示逻辑（已优化）
  - 确保界面布局不受影响
  - _需求: 2.1, 2.2_

- [ ] 4.2 更新游戏编辑界面
  - 在 `GameEditDialog.tsx` 中添加平台名称显示
  - 确保编辑功能正常工作
  - 添加新字段的表单验证
  - _需求: 2.1, 2.2_

- [ ] 4.3 更新统计信息显示
  - 在 `StatsOverview.tsx` 中适配新的数据结构
  - 确保统计计算正确
  - 测试数据加载和显示
  - _需求: 2.1, 5.2_

- [ ] 4.4 测试前端兼容性
  - 验证所有页面正常加载和显示
  - 测试新旧数据的混合显示
  - 确保用户体验无明显变化
  - _需求: 5.2, 5.3_

### 5. 数据迁移和验证

- [ ] 5.1 执行数据库迁移
  - 在生产环境中执行迁移脚本
  - 监控迁移过程和系统性能
  - 验证迁移完成和数据完整性
  - _需求: 4.1, 4.2, 4.3_

- [ ] 5.2 批量重新爬取游戏数据
  - 创建批量爬取脚本
  - 优先处理NS2游戏（容量问题最严重）
  - 监控爬取进度和成功率
  - _需求: 1.1, 1.2, 1.3, 1.4_

- [ ] 5.3 数据质量验证
  - 验证容量信息的准确性（特别是NS2游戏）
  - 检查平台名称显示的正确性
  - 验证截图URL的有效性
  - _需求: 1.1, 2.1, 3.1_

- [ ] 5.4 性能监控和优化
  - 监控系统性能指标
  - 检查API响应时间
  - 验证数据库查询性能
  - _需求: 性能需求_

### 6. 部署和监控

- [ ] 6.1 准备部署计划
  - 制定分阶段部署策略
  - 准备回滚计划和脚本
  - 设置监控和告警机制
  - _需求: 4.3, 5.3_

- [ ] 6.2 执行生产部署
  - 按计划部署各个组件
  - 监控部署过程和系统状态
  - 验证所有功能正常工作
  - _需求: 5.3_

- [ ] 6.3 后部署验证
  - 执行完整的功能测试
  - 验证数据准确性和完整性
  - 收集用户反馈
  - _需求: 成功标准_

- [ ] 6.4 文档更新
  - 更新技术文档和API文档
  - 记录变更内容和影响
  - 更新部署和维护指南
  - _需求: 可维护性需求_

## 风险缓解措施

### 高风险任务
- **任务 2.1, 5.1**: 数据库迁移
  - 缓解：充分测试，准备回滚脚本
- **任务 5.2**: 批量数据重新爬取
  - 缓解：分批处理，监控系统负载

### 关键路径
1. 爬虫优化 (1.1-1.5) → 数据库迁移 (2.1-2.3) → API适配 (3.1-3.3) → 前端适配 (4.1-4.4) → 部署 (6.1-6.4)

### 并行任务
- 任务 1.x 和 2.x 可以并行开发
- 任务 3.x 和 4.x 可以在数据库迁移完成后并行进行

## 验收标准

每个任务完成后需要满足：
1. 功能正确性：实现预期功能
2. 代码质量：通过代码审查和测试
3. 性能要求：不显著影响系统性能
4. 兼容性：保持向后兼容
5. 文档完整：更新相关文档