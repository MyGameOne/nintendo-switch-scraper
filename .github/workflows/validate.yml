name: Validate Game IDs

on:
  pull_request:
    paths:
      - 'data/game-ids.json'
  
  push:
    paths:
      - 'data/game-ids.json'
    branches-ignore:
      - main
      - master

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Install dependencies
        run: |
          if [ -f "pnpm-lock.yaml" ]; then
            echo "ðŸ“¦ ä½¿ç”¨é”å®šæ–‡ä»¶å®‰è£…ä¾èµ–..."
            pnpm install --frozen-lockfile
          else
            echo "ðŸ“¦ ç”Ÿæˆé”å®šæ–‡ä»¶å¹¶å®‰è£…ä¾èµ–..."
            pnpm install
          fi
      
      - name: Validate game-ids.json format
        run: pnpm validate
      
      - name: Show changes
        if: github.event_name == 'pull_request'
        run: |
          echo "## ðŸ“ Game IDs å˜æ›´æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # èŽ·å–å˜æ›´å‰åŽçš„æ–‡ä»¶
          git fetch origin ${{ github.base_ref }}
          
          if git show origin/${{ github.base_ref }}:data/game-ids.json > /tmp/old-game-ids.json 2>/dev/null; then
            # ä½¿ç”¨ Node.js å¤„ç† JSON æ¯”è¾ƒ
            node -e "
              const fs = require('fs');
              const oldIds = JSON.parse(fs.readFileSync('/tmp/old-game-ids.json', 'utf8'));
              const newIds = JSON.parse(fs.readFileSync('data/game-ids.json', 'utf8'));
              
              console.log('### ðŸ“Š æ•°é‡å˜åŒ–');
              console.log('- å˜æ›´å‰: ' + oldIds.length);
              console.log('- å˜æ›´åŽ: ' + newIds.length);
              console.log('- å·®å¼‚: ' + (newIds.length - oldIds.length));
              console.log('');
              
              const oldSet = new Set(oldIds);
              const newSet = new Set(newIds);
              
              const added = newIds.filter(id => !oldSet.has(id));
              const removed = oldIds.filter(id => !newSet.has(id));
              
              if (added.length > 0) {
                console.log('### âž• æ–°å¢žçš„æ¸¸æˆ ID');
                added.forEach(id => console.log('- ' + id));
                console.log('');
              }
              
              if (removed.length > 0) {
                console.log('### âž– åˆ é™¤çš„æ¸¸æˆ ID');
                removed.forEach(id => console.log('- ' + id));
                console.log('');
              }
            " >> $GITHUB_STEP_SUMMARY
          else
            node -e "
              const fs = require('fs');
              const newIds = JSON.parse(fs.readFileSync('data/game-ids.json', 'utf8'));
              console.log('### ðŸ“ æ–°æ–‡ä»¶');
              console.log('è¿™æ˜¯ä¸€ä¸ªæ–°çš„ game-ids.json æ–‡ä»¶ï¼ŒåŒ…å« ' + newIds.length + ' ä¸ªæ¸¸æˆ IDã€‚');
            " >> $GITHUB_STEP_SUMMARY
          fi